#!/bin/bash
set -ex

# HOME variable will expan to /home/iguana
OUT=${HOME}/.shared

if [ ! -s "${OUT}/wp" ]; then
    echo "=========================="
    echo " Starting initialization!!!"
    echo "Once privkeys are imported container will exit!!!"
    echo "Then you need to start komodo and iguana containers again."
    echo "They suppose to be started with pubkeys."
    echo "=========================="
    
    # Make all files and directories writable only to owner and readable to user
    umask 0027

    if [ -z $IGUANA_WALLET_PASSPHRASE ];then
	echo "IGUANA_WALLET_PASSPHRASE variable not set!"
	echo "Type very secure passphrase for your wallet:"
	read IGUANA_WALLET_PASSPHRASE
    fi    

 
    # Make dir on volume for generated files
    # if [ ! -d  ${OUT} ];then
    #	mkdir ${OUT}
    # fi
    # Start iguana + basilik 
    # ${HOME}/SuperNET/agents/iguana | tee -a /tmp/iguana_agent_.txt && \
    #sleep 10 && \
    echo "Starting basilisk.old..."
    cd ${HOME}/SuperNET/iguana/coins
    ${HOME}/SuperNET/iguana/coins/basilisk.old


    # Create Iguana wallet with passphrase defined in .env file
    echo "Creating wallet:"
    BITCOIN_OUT=`curl --url "http://127.0.0.1:7778" --data "{\"agent\":\"bitcoinrpc\",\"method\":\"encryptwallet\",\"passphrase\":\"${IGUANA_WALLET_PASSPHRASE}\"}"`
    echo ${BITCOIN_OUT} | tee -a ${OUT}/keys.txt

    # wp file does not exist - it will be created now
    echo "Creating wp file"
    cat <<EOF > ${OUT}/wp
    # The walletpassphrase RPC stores the wallet decryption key in memory for the indicated number of seconds.
    curl --url "http://127.0.0.1:7778" --data "{\"method\":\"walletpassphrase\",\"params\":[\"\\${IGUANA_WALLET_PASSPHRASE}\", 9999999]}"
EOF
    # Change permissions to wp file and add symlinks
    chmod u+x ${OUT}/wp
    cat ${OUT}/wp > ${OUT}/wp_7776 && chmod u+x ${OUT}/wp_7776
    echo "Creating wp symlinks:"
    cd ${HOME}/SuperNET/iguana && ln -s ${OUT}/wp wp
    #ln -s ${OUT}/wp_7776 wp_7776

    ### ====================== Parse KEYs ===================================
    #The walletpassphrase RPC stores the wallet decryption key in memory for the indicated number of seconds.
    cd ${HOME}/SuperNET/iguana/
    ${HOME}/SuperNET/iguana/wp | tee -a ${OUT}/wp_out.txt

    # SEND TO KOLO
    BTCPUBKEY=`cat ${OUT}/keys.txt | sed -n 's/^.*"btcpubkey":"\(.[^"]*\).*$/\1/gp'`
    echo "This is btcpubkey - send it to KOLO:"
    echo "${BTCPUBKEY}"


    #PUBKEY=`cat ${HOME}/.iguana/keys.txt | sed -n 's/^.*"pubkey":"\(.[^"]*\).*$/\1/gp'`
    #echo "This is pubkey: ${PUBKEY}"
    echo "pubkey=${BTCPUBKEY}" | tee -a ${OUT}/pubkey.txt
    ln -s ${OUT}/pubkey.txt ${HOME}/SuperNET/iguana/pubkey.txt

    # In komodo container, we must create symlink to this file
    #echo "pubkey=${BTCPUBKEY}" | tee -a /home/komodo/.komodo/pubkey.txt

    echo "BTCwif is:"
    BTCWIF=`cat ${OUT}/keys.txt | sed -n 's/^.*"BTCwif":"\(.[^"]*\).*$/\1/gp'`
    echo ${BTCWIF}

    echo "BTC address is:"
    BTCADDR=`cat ${OUT}/keys.txt | sed -n 's/^.*"BTC":"\(.[^"]*\).*$/\1/gp'`
    echo ${BTCADDR}

    echo "BTCDwif is:"
    BTCDWIF=`cat ${OUT}/keys.txt | sed -n 's/^.*"BTCDwif":"\(.[^"]*\).*$/\1/gp'`
    echo ${BTCDWIF}


    ### ====================== KOMODO Import BTCD privkey ===================================
    # # use rescan=false param to bitcoin-cli to finish it faster?
    # /komodo/src/komodo-cli importprivkey ${BTCDWIF} 
    # BTCD_ISMINE=`/komodo/src/komodo-cli validateaddress ${BTCADDR}`
    # if echo ${BTCD_ISMINE} | grep -q '"ismine": true';then
    #     echo "BTCD privkey imported successfully!!!"
    # else
    #     echo "BTCD privkey import FAILED!!!"
    # fi
    # 
    # # This is seen in komodo logs- it is checking if key was not used before
    # # Still rescanning. At block 184551. Progress=0.137976
    # # Still rescanning. At block 205351. Progress=0.157062
    # # Still rescanning. At block 229526. Progress=0.175925
    # # Still rescanning. At block 252962. Progress=0.195673
    # 
    # 
    ### ====================== BITCOIN Import BTC privkey ===================================
    # # Import BTC priv key into bitcoin:
    # # use rescan=false param to bitcoin-cli to have it faster?
    # bitcoin-cli importprivkey ${BTCWIF} &
    # BTC_ISMINE=`bitcoin-cli validateaddress ${BTCWIF}`
    # if echo ${BTC_ISMINE} | grep -q '"ismine": true';then
    #     echo "BTC privkey imported successfully!!!"
    # else
    #     echo "BTC privkey import FAILED!!!"
    # fi

    # # This is seen in  bitcoind logs, it is checking if key was not used before
    # # Still rescanning. At block 184551. Progress=0.137976
    # # Still rescanning. At block 205351. Progress=0.157062
    # # Still rescanning. At block 229526. Progress=0.175925
    # # Still rescanning. At block 252962. Progress=0.195673

    # 
    if [ ! -s ${HOME}/SuperNET/iguana/userhome.txt ];then
	echo "home/iguana" > ${OUT}/userhome.txt
	ln -s ${OUT}/userhome.txt ${HOME}/SuperNET/iguana/userhome.txt
    fi

    
    ### ====================== Change ports to 7776 ===================================
    IFS=' '
    COINS="btc kmd"
    for COIN in `echo $COINS`;do
	cp ~/SuperNET/iguana/coins/${COIN} ~/SuperNET/iguana/
	sed -i 's/7778/7776/g' ~/SuperNET/iguana/${COIN} 
    done
    sed -i 's/7778/7776/g' ${OUT}/wp_7776
    cd ${HOME}/SuperNET/iguana && ln -s ${OUT}/wp_7776 wp_7776

    # cp ${HOME}/.iguana/gensecret/wp  ${HOME}/.iguana/gensecret/wp_7776 
    # cp ${HOME}/SuperNET/iguana/wp ${HOME}/SuperNET/iguana/wp_7776


    # Change permissions so only iguana container can write to this volume and group can read only
    chown iguana:shared -R ${HOME}/.shared/
    chmod 0750 ${HOME}/.shared
    # chmod 0640 -R ${HOME}/.shared/*
    echo "Initialization completed successfully"
fi
